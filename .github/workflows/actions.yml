
name: CI

on:
  push:
    branches: [ main, feat/* ]
  pull_request:
  workflow_dispatch:

permissions:
  actions: write
  checks: write
  contents: write
  id-token: write
  issues: write
  discussions: write
  pull-requests: write
  statuses: write

jobs:
  contracts:
    name: Contracts
    uses: multiversx/mx-sc-actions/.github/workflows/contracts.yml@v4.2.2
    with:
      rust-toolchain: 1.87
      coverage-args: --ignore-filename-regex='/.cargo/git' --output ./coverage.md
      enable-interactor-tests: false
    secrets:
      token: ${{ secrets.GITHUB_TOKEN }}

  interactor-tests:
    name: Interactor Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: 1.87
          target: wasm32-unknown-unknown

      - name: Install prerequisites
        run: |
          cargo install multiversx-sc-meta

      - name: Build contracts and generate proxies
        run: |
          sc-meta all build
          sc-meta all proxy

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Setup Docker
        run: |
          sudo systemctl start docker || true
          docker pull multiversx/chainsimulator || true

      - name: Run targeted interactor test via wrapper
        env:
          PATH: ${{ github.workspace }}/interactor/scripts:${{ env.PATH }}
          WORKSPACE_ROOT: ${{ github.workspace }}
          MAX_TEST_CONCURRENCY: "4"
          GITHUB_ACTIONS: "true"
        run: |
          cargo test --package rust-interact --test complete_flow_tests --all-features || true
          cargo test --package rust-interact --test mvx_esdt_safe_tests --all-features || true

      - name: Cleanup chain simulator containers
        if: always()
        run: |
          # Remove only the per-test chain simulator containers created by the wrapper
          CONTAINERS=$(docker ps -a --filter "name=chain-sim-" --format "{{.ID}}")
          if [ -n "$CONTAINERS" ]; then
            docker rm -f $CONTAINERS
          fi

      - name: Interactor test summary
        if: always()
        run: |
          if [ -f "${{ github.workspace }}/interactor_test_summary.md" ]; then
            cat "${{ github.workspace }}/interactor_test_summary.md" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## Interactor Test Summary" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "⚠️ Summary file not found. Tests may have failed before summary could be written." >> "$GITHUB_STEP_SUMMARY"
          fi
  
